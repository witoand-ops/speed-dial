<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%237c83ff'/%3E%3Crect x='4' y='4' width='10' height='10' rx='2' fill='%23fff' fill-opacity='.9'/%3E%3Crect x='18' y='4' width='10' height='10' rx='2' fill='%23fff' fill-opacity='.7'/%3E%3Crect x='4' y='18' width='10' height='10' rx='2' fill='%23fff' fill-opacity='.7'/%3E%3Crect x='18' y='18' width='10' height='10' rx='2' fill='%23fff' fill-opacity='.5'/%3E%3C/svg%3E">
<title>Speed Dial Groups</title>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>

*{margin:0;padding:0;box-sizing:border-box}
:root{--fs-tab:13px;--fs-dial:11px;--fs-cat:11px;--fs-logo:15px;--fw-dial:600;--fc-tab:#9090b0;--fc-dial:#fff;--fc-cat:#606080;--fc-logo:#7c83ff;--dial-radius:12px}
body{font-family:system-ui,sans-serif;background:#0f0f1a;color:#e8e8f0;min-height:100vh}
[data-t=l] body{background:#f0f0f8;color:#1a1a2e}
[data-t=l] header{background:rgba(240,240,248,.9)}
[data-t=l] .tabs{border-color:rgba(100,100,180,.15)}
[data-t=l] .tab{color:#555570}
[data-t=l] .tab.on{color:#fff}
[data-t=l] .dial{background:#fff;border-color:rgba(100,100,180,.15)}
[data-t=l] .dial.add{background:transparent}
[data-t=l] #themebtn{background:#fff;color:#555570;border-color:rgba(100,100,180,.15)}
[data-t=l] .clock .time,[data-t=l] .clock .date{color:#333}
[data-t=l] .overlay{background:rgba(0,0,0,.4)}
[data-t=l] .mpanel{background:#fff;border-color:rgba(100,100,180,.15)}
[data-t=l] .mpanel .mhead{border-color:rgba(100,100,180,.15)}
[data-t=l] .mpanel .mfoot{border-color:rgba(100,100,180,.15)}
[data-t=l] .mpanel input[type=text],[data-t=l] .mpanel input[type=url],[data-t=l] .mpanel input[type=number],[data-t=l] .mpanel textarea,[data-t=l] .mpanel select{background:#f0f0f8;border-color:rgba(100,100,180,.15);color:#1a1a2e}
[data-t=l] .mpanel label{color:#555570}
[data-t=l] .closebtn{color:#555570}
[data-t=l] .sbtn{color:#555570;border-color:rgba(100,100,180,.15)}
[data-t=l] .stab{color:#555570}
[data-t=l] .srow{border-color:rgba(100,100,180,.08)}
[data-t=l] .rng{border-color:rgba(100,100,180,.08)}
[data-t=l] .toast{background:#fff;color:#1a1a2e;border-color:rgba(100,100,180,.15)}
[data-t=l] .hb{color:#555570}
[data-t=l] .hb:hover{color:#5c63e0;background:rgba(92,99,224,.1)}
[data-t=l] .addg{border-color:rgba(100,100,180,.3);color:#999}
[data-t=l] .cat-bar{border-color:rgba(100,100,180,.08)}
[data-t=l] .cat-btn{color:#555570}
[data-t=l] .cat-btn.on{color:#5c63e0;background:rgba(92,99,224,.1)}
[data-t=l] .tsi{border-color:rgba(100,100,180,.12)}
[data-t=l] .mvi{background:#f8f8fc;border-color:rgba(100,100,180,.12)}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:rgba(15,15,26,.9);border-bottom:1px solid rgba(124,131,255,.15);position:sticky;top:0;z-index:100}
.logo{font-weight:700;font-size:var(--fs-logo);color:var(--fc-logo)}
.hbtns{display:flex;gap:4px}
.hb{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:none;border:1px solid transparent;border-radius:10px;cursor:pointer;font-size:18px;color:#9090b0}
.hb:hover{background:rgba(124,131,255,.15);border-color:rgba(124,131,255,.25);color:#7c83ff}
.tabs{display:flex;align-items:center;gap:4px;padding:8px 20px;border-bottom:1px solid rgba(124,131,255,.15);flex-wrap:wrap}
.cat-bar{display:flex;gap:4px;padding:4px 20px;border-bottom:1px solid rgba(124,131,255,.08);overflow-x:auto}
.cat-btn{padding:4px 12px;border:none;border-radius:6px;font-family:inherit;font-size:var(--fs-cat);cursor:pointer;color:var(--fc-cat);background:none;white-space:nowrap}
.cat-btn:hover{background:rgba(124,131,255,.08)}
.cat-btn.on{color:#7c83ff;background:rgba(124,131,255,.12);font-weight:600}
.tab{padding:6px 16px;border:none;border-radius:8px;font-family:inherit;font-size:var(--fs-tab);cursor:pointer;color:var(--fc-tab);background:none;white-space:nowrap}
.tab:hover{background:rgba(124,131,255,.1)}
.tab.on{color:#fff}
.addg{width:28px;height:28px;border:1px dashed rgba(124,131,255,.3);border-radius:8px;background:none;color:#606080;font-size:18px;cursor:pointer;margin-left:auto;flex-shrink:0}
.addg:hover{color:#7c83ff;border-color:#7c83ff}
#grid{display:grid;gap:16px;padding:24px;justify-content:center;width:100%}
.dial{border-radius:var(--dial-radius);cursor:pointer;position:relative;overflow:hidden;border:1px solid rgba(124,131,255,.15);background:#1c1c35;transition:transform .2s,box-shadow .2s}
.dial:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.dial .thumb{position:absolute;inset:0}
.dial .thumb img{width:100%;height:100%;object-fit:cover;object-position:top;display:block}
.dial .fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:800;color:rgba(255,255,255,.5);text-transform:uppercase}
.dial .grad{position:absolute;top:0;left:0;right:0;height:40px;background:linear-gradient(rgba(0,0,0,.75),transparent);z-index:1}
.dial .info{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;gap:5px;padding:7px 10px;z-index:2}
.dial .info img{width:14px;height:14px;border-radius:2px}
.dial .info span{font-size:var(--fs-dial);font-weight:var(--fw-dial);color:var(--fc-dial);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-shadow:0 1px 2px rgba(0,0,0,.6)}
.dial.add{border-style:dashed;border-color:#606080;opacity:.5;display:flex;flex-direction:column;align-items:center;justify-content:center;background:transparent}
.dial.add:hover{opacity:1;border-color:#7c83ff}
#pagi{display:flex;justify-content:center;gap:6px;padding:0 24px 20px;align-items:center}
#pagi button{padding:4px 10px;border-radius:6px;border:1px solid rgba(124,131,255,.15);background:none;color:#9090b0;cursor:pointer;font-size:12px}
#pagi button.on{background:#7c83ff;color:#fff}
#pagi button:disabled{opacity:.3}
.clock{position:fixed;bottom:20px;right:20px;text-align:right;pointer-events:none;z-index:50;font-family:monospace}
.clock .time{font-size:18px;opacity:.6}
.clock .date{font-size:11px;opacity:.4}
#themebtn{position:fixed;bottom:20px;left:20px;z-index:50;padding:6px 12px;border-radius:16px;border:1px solid rgba(124,131,255,.15);background:#1c1c35;color:#9090b0;font-size:11px;cursor:pointer}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:none;align-items:center;justify-content:center}
.overlay.open{display:flex}
.mpanel{background:#161628;border:1px solid rgba(124,131,255,.15);border-radius:14px;box-shadow:0 8px 40px rgba(0,0,0,.5);width:440px;max-width:95vw;max-height:85vh;overflow-y:auto}
.mpanel.wide{width:560px}
.mpanel .mhead{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(124,131,255,.15)}
.mpanel .mhead h3{font-size:14px;font-weight:600}
.closebtn{background:none;border:none;color:#9090b0;font-size:20px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px}
.closebtn:hover{background:rgba(124,131,255,.15);color:#7c83ff}
.mpanel .mbody{padding:14px 18px}
.mpanel .mfoot{display:flex;justify-content:flex-end;gap:8px;padding:12px 18px;border-top:1px solid rgba(124,131,255,.15)}
.mpanel label{display:block;font-size:12px;color:#9090b0;margin-bottom:10px}
.mpanel input[type=text],.mpanel input[type=url],.mpanel input[type=number],.mpanel textarea,.mpanel select{display:block;width:100%;margin-top:4px;padding:8px 10px;background:#1a1a30;border:1px solid rgba(124,131,255,.15);border-radius:8px;color:#e8e8f0;font-family:inherit;font-size:13px;outline:none}
.mpanel input:focus,.mpanel textarea:focus{border-color:#7c83ff}
.mpanel textarea{min-height:60px;resize:vertical}
.pbtn{padding:7px 16px;border-radius:8px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;border:none;background:#7c83ff;color:#fff}
.sbtn{padding:7px 16px;border-radius:8px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;border:1px solid rgba(124,131,255,.15);background:none;color:#9090b0}
.stabs{display:flex;border-bottom:1px solid rgba(124,131,255,.15);margin-bottom:12px}
.stab{padding:8px 12px;background:none;border:none;border-bottom:2px solid transparent;font-family:inherit;font-size:12px;cursor:pointer;color:#9090b0}
.stab.on{color:#7c83ff;border-bottom-color:#7c83ff}
.srow{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(124,131,255,.06)}
.rng{padding:10px 0;border-bottom:1px solid rgba(124,131,255,.06)}
.rng .rh{display:flex;justify-content:space-between;margin-bottom:4px}
.rng .rv{font-family:monospace;font-weight:700;color:#7c83ff;font-size:13px}
.rng input[type=range]{width:100%;accent-color:#7c83ff}
.tsi{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:6px;cursor:pointer;border:1px solid rgba(124,131,255,.08)}
.tsi:hover{border-color:rgba(124,131,255,.3)}
.tsi img{width:16px;height:16px;border-radius:2px}
.tsi .nm{font-size:12px;flex:1}
.tsi .ad{color:#7c83ff;font-size:15px;opacity:0;cursor:pointer}
.tsi:hover .ad{opacity:1}
.mvi{padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13px;margin-bottom:4px;border:1px solid rgba(124,131,255,.1);background:#1c1c35}
.mvi:hover{border-color:#7c83ff;color:#7c83ff}
.tmrd{font-family:monospace;font-size:40px;color:#7c83ff;text-align:center;margin:14px 0;letter-spacing:2px}
.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:#161628;border:1px solid rgba(124,131,255,.15);border-radius:8px;padding:8px 18px;font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.v{opacity:1}


#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}
#loginScreen h1{font-size:28px;color:#7c83ff;font-weight:700}
#loginScreen p{color:#9090b0;font-size:13px;max-width:380px;text-align:center;line-height:1.6}
#loginScreen .note{color:#606080;font-size:11px;margin-top:12px;text-align:center;line-height:1.7;max-width:420px}
#loginScreen .note a{color:#7c83ff}
#authBtn{padding:12px 28px;border-radius:24px;border:none;background:#7c83ff;color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
#authBtn:hover{background:#9198ff}
#authLoading{color:#606080;font-size:12px}
#appScreen{display:none}
.user-bar{display:flex;align-items:center;gap:8px;margin-right:8px}
.user-bar img{width:28px;height:28px;border-radius:50%;border:2px solid rgba(124,131,255,.3)}
.user-bar span{font-size:12px;color:#9090b0;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lout{background:none;border:1px solid rgba(255,92,108,.3);border-radius:6px;color:#ff5c6c;font-size:11px;padding:3px 8px;cursor:pointer;font-family:inherit}
.lout:hover{background:rgba(255,92,108,.1)}
.sync{font-size:10px;color:#606080;position:fixed;bottom:22px;right:140px;pointer-events:none;z-index:50}


.dial .refresh-btn{position:absolute;bottom:5px;left:5px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,.6);border:none;color:#fff;font-size:12px;cursor:pointer;z-index:3;opacity:0;transition:opacity .2s;display:flex;align-items:center;justify-content:center}
.dial:hover .refresh-btn{opacity:1}
.dial .refresh-btn:hover{background:rgba(124,131,255,.8)}

.ctx-menu{position:fixed;z-index:1000;background:#1c1c35;border:1px solid rgba(124,131,255,.2);border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,.5);min-width:180px;padding:4px 0;display:none}
.ctx-menu.v{display:block}
.ctx-menu .ctx-item{padding:8px 14px;font-size:12px;color:#e8e8f0;cursor:pointer;display:flex;align-items:center;gap:8px}
.ctx-menu .ctx-item:hover{background:rgba(124,131,255,.15)}
.ctx-menu .ctx-sep{height:1px;background:rgba(124,131,255,.1);margin:4px 0}
[data-t=l] .ctx-menu{background:#fff;border-color:rgba(100,100,180,.15);box-shadow:0 8px 30px rgba(0,0,0,.15)}
[data-t=l] .ctx-menu .ctx-item{color:#1a1a2e}
[data-t=l] .ctx-menu .ctx-item:hover{background:rgba(92,99,224,.1)}
[data-t=l] .ctx-menu .ctx-sep{background:rgba(100,100,180,.1)}
</style>
</head>
<body>

<div id="loginScreen">
  <h1><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-4px;margin-right:6px"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Speed Dial Groups</h1>
  <p>Jelentkezz be Google fiókoddal.<br>Az adataid a saját Google Drive-odban tárolódnak, biztonságban.</p>
  <button id="authBtn">&#128274; Bejelentkezés Google-lel</button>
  <div id="authLoading" style="font-size:11px;color:#606080">Google API betöltése...</div>
  <div class="note">
    Első használathoz szükséges egy Google Cloud OAuth Client ID.<br>
    Részletes útmutató: <a href="https://github.com/user/speed-dial-groups#readme" target="_blank">README</a>
  </div>
</div>
<div id="appScreen">


<header>
  <div class="logo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Speed Dial Groups</div>
  <div style="display:flex;align-items:center;gap:6px">
    <div class="user-bar" id="userBar"></div>
    <div class="hbtns">
      <button class="hb" id="btnTop" title="Top oldalak"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg></button>
      <button class="hb" id="btnTimer" title="Időzítő"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></button>
      <button class="hb" id="btnNotes" title="Jegyzetek"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></button>
      <button class="hb" id="btnSettings" title="Beállítások"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
    </div>
  </div>
</header>

<div class="cat-bar" id="catBar"></div>
<div class="tabs" id="tabsBar">
  <div id="groupTabs" style="display:flex;gap:4px;flex:1;overflow-x:auto;flex-wrap:wrap"></div>
  <button class="addg" id="addGroupBtn">+</button>
</div>

<div id="grid"></div>
<div id="pagi"></div>

<div class="clock" id="clockWidget">
  <div class="time" id="clockTime"></div>
  <div class="date" id="clockDate"></div>
</div>
<button id="themebtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>Téma</button>

<div class="ctx-menu" id="ctxMenu"></div>
<div class="overlay" id="overlay"></div>
<div class="sync" id="syncInd"></div>
<div class="toast" id="toast"></div>


</div>
<script>
// Google Drive integration

// =======================================
// GOOGLE DRIVE AUTH + STORAGE
// =======================================

// >>> IDE ÍRD BE a saját Google Cloud OAuth Client ID-dat <<<
var CLIENT_ID = '581358319483-002caa9u9sjobdbbe8al8vj513nc7tjf.apps.googleusercontent.com';

var SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.profile';
var DATA_FILE = 'speed-dial-data.json';
var tokenClient = null;
var accessToken = null;
var driveFileId = null;
var driveLoaded = false;

// Called when gapi.js loads
function gapiLoaded() {
  gapi.load('client', function() {
    gapi.client.init({}).then(function() {
      return gapi.client.load('drive', 'v3');
    }).then(function() {
      initGIS();
    });
  });
}

// Called after gapi is ready
function initGIS() {
  if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
    setTimeout(initGIS, 300);
    return;
  }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: onToken
  });

  // Check saved token
  var saved = localStorage.getItem('sd_gtoken');
  if (saved) {
    accessToken = saved;
    gapi.client.setToken({access_token: accessToken});
    // Verify token is still valid
    gapi.client.request({path: 'https://www.googleapis.com/oauth2/v2/userinfo'})
    .then(function(r) { enterApp(r.result); })
    .catch(function() {
      // Token expired - try silent refresh
      localStorage.removeItem('sd_gtoken');
      accessToken = null;
      if (tokenClient) {
        try { tokenClient.requestAccessToken({prompt: ''}); } catch(e) { showLogin(); }
      } else {
        showLogin();
      }
    });
  } else {
    showLogin();
  }
}

function showLogin() {
  document.getElementById('authLoading').style.display = 'none';
  document.getElementById('authBtn').style.display = 'inline-block';
}

// Fallback: if Google APIs don't load within 5 seconds, show button anyway with error
var _loginTimeout = setTimeout(function() {
  var btn = document.getElementById('authBtn');
  var loading = document.getElementById('authLoading');
  if (btn && btn.style.display === 'none') {
    loading.textContent = 'Google API betöltési hiba. Próbáld kikapcsolni az adblocker-t, majd frissítsd az oldalt.';
    loading.style.color = '#ff5c6c';
    btn.style.display = 'inline-block';
  }
}, 5000);

function onToken(resp) {
  if (resp.error) { console.error('Token error:', resp); return; }
  accessToken = resp.access_token;
  localStorage.setItem('sd_gtoken', accessToken);
  gapi.client.setToken({access_token: accessToken});
  gapi.client.request({path: 'https://www.googleapis.com/oauth2/v2/userinfo'})
  .then(function(r) { enterApp(r.result); })
  .catch(function(e) { console.error(e); alert('Hiba a bejelentkezéskor'); });
}

function enterApp(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';

  var bar = document.getElementById('userBar');
  bar.innerHTML = '';
  if (user.picture) {
    var img = document.createElement('img');
    img.src = user.picture;
    img.referrerPolicy = 'no-referrer';
    bar.appendChild(img);
  }
  var sp = document.createElement('span');
  sp.textContent = user.name || user.email || '';
  bar.appendChild(sp);
  var lb = document.createElement('button');
  lb.className = 'lout';
  lb.textContent = 'Kilépés';
  lb.addEventListener('click', function() {
    try { google.accounts.oauth2.revoke(accessToken); } catch(e) {}
    localStorage.removeItem('sd_gtoken');
    location.reload();
  });
  bar.appendChild(lb);

  // Now load data from Drive
  driveLoad();
}

function syncMsg(m) {
  var el = document.getElementById('syncInd');
  if (el) el.textContent = m;
}

// Find the data file in appDataFolder
function driveFindFile() {
  return gapi.client.drive.files.list({
    spaces: 'appDataFolder',
    q: "name = '" + DATA_FILE + "'",
    fields: 'files(id)',
    pageSize: 1
  }).then(function(r) {
    var f = r.result.files;
    if (f && f.length > 0) { driveFileId = f[0].id; return true; }
    return false;
  });
}

// Load data from Google Drive
function driveLoad() {
  syncMsg('Betöltés...');
  driveFindFile().then(function(found) {
    if (!found) {
      // First time - use defaults, then save
      syncMsg('Új profil');
      driveLoaded = true;
      checkAddParam();
      return driveSaveNow();
    }
    return gapi.client.drive.files.get({fileId: driveFileId, alt: 'media'}).then(function(r) {
      var d = r.result;
      if (d && d.groups && d.groups.length > 0) groups = d.groups;
      if (d && d.settings) settings = Object.assign(settings, d.settings);
      if (d && d.notes !== undefined) notes = d.notes;
      if (d && typeof d.activeGroup === 'number') activeGroup = d.activeGroup;
      // Use homeGroup as default on fresh load
      if (typeof settings.homeGroup === 'number' && settings.homeGroup < groups.length) {
        activeGroup = settings.homeGroup;
      }
      if (activeGroup >= groups.length) activeGroup = 0;
      page = 0;
      applySettings();
      renderGroups();
      renderDials();
      driveLoaded = true;
      syncMsg('✓ Betöltve');
      setTimeout(function() { syncMsg(''); }, 2500);
      // Check if there's a pending add from bookmarklet
      checkAddParam();
    });
  }).catch(function(e) {
    console.error('Drive load error:', e);
    syncMsg('✗ Betöltési hiba');
    applySettings();
    renderGroups();
    renderDials();
  });
}

// Save data to Google Drive (debounced)
var _dsTimer = null;
function driveSave() {
  clearTimeout(_dsTimer);
  _dsTimer = setTimeout(driveSaveNow, 800);
}

function driveSaveNow() {
  if (!accessToken) return Promise.resolve();
  syncMsg('Mentés...');
  var payload = JSON.stringify({
    groups: groups,
    settings: settings,
    notes: notes,
    activeGroup: activeGroup
  });

  if (driveFileId) {
    // Update
    return fetch('https://www.googleapis.com/upload/drive/v3/files/' + driveFileId + '?uploadType=media', {
      method: 'PATCH',
      headers: {'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json'},
      body: payload
    }).then(function(r) {
      syncMsg(r.ok ? '✓ Mentve' : '✗ Hiba');
      setTimeout(function() { syncMsg(''); }, 2500);
    }).catch(function() { syncMsg('✗ Mentési hiba'); });
  } else {
    // Create
    var meta = {name: DATA_FILE, parents: ['appDataFolder'], mimeType: 'application/json'};
    var form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
    form.append('file', new Blob([payload], {type: 'application/json'}));
    return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + accessToken},
      body: form
    }).then(function(r) { return r.json(); })
    .then(function(r) {
      if (r.id) driveFileId = r.id;
      syncMsg('✓ Mentve');
      setTimeout(function() { syncMsg(''); }, 2500);
    }).catch(function() { syncMsg('✗ Mentési hiba'); });
  }
}


// Auth button handler
document.getElementById('authBtn').addEventListener('click', function() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    document.getElementById('authLoading').textContent = 'A Google API még nem töltődött be. Próbáld kikapcsolni az adblocker-t, majd frissítsd az oldalt (Ctrl+Shift+R).';
    document.getElementById('authLoading').style.color = '#ff5c6c';
  }
});

// === SPEED DIAL APP ===
// === DATA ===
var COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e84393','#6c5ce7','#00b894'];
var SITES = [['Facebook','https://www.facebook.com'],['YouTube','https://www.youtube.com'],['Maps','https://maps.google.com'],['X/Twitter','https://x.com'],['Instagram','https://www.instagram.com'],['LinkedIn','https://www.linkedin.com'],['Amazon','https://www.amazon.com'],['Wikipedia','https://hu.wikipedia.org'],['Netflix','https://www.netflix.com'],['Reddit','https://www.reddit.com']];
var ENGINES = {google:'https://www.google.com/search?q=',bing:'https://www.bing.com/search?q=',ddg:'https://duckduckgo.com/?q='};

var groups, settings, notes, activeGroup, activeCat, page, fails;

function defaults() {
  groups = [
    {n:'Kezdőlap',c:'#7c83ff',cols:5,rows:3,dw:220,dh:170,d:[
      {i:'1',t:'Google',u:'https://www.google.com',m:''},
      {i:'2',t:'YouTube',u:'https://www.youtube.com',m:''},
      {i:'3',t:'Gmail',u:'https://mail.google.com',m:''},
      {i:'4',t:'Wikipedia',u:'https://hu.wikipedia.org',m:''},
      {i:'5',t:'Reddit',u:'https://www.reddit.com',m:''},
      {i:'6',t:'GitHub',u:'https://github.com',m:''},
      {i:'7',t:'Twitter/X',u:'https://x.com',m:''},
      {i:'8',t:'StackOverflow',u:'https://stackoverflow.com',m:''},
      {i:'9',t:'ChatGPT',u:'https://chat.openai.com',m:''},
      {i:'10',t:'Amazon',u:'https://www.amazon.com',m:''}
    ]},
    {n:'Munka',c:'#2ecc71',cols:5,rows:3,dw:220,dh:170,d:[
      {i:'11',t:'Drive',u:'https://drive.google.com',m:''},
      {i:'12',t:'Slack',u:'https://slack.com',m:''},
      {i:'13',t:'Notion',u:'https://www.notion.so',m:''}
    ]},
    {n:'Szórakozás',c:'#e74c3c',cols:5,rows:3,dw:220,dh:170,d:[
      {i:'14',t:'Netflix',u:'https://www.netflix.com',m:''},
      {i:'15',t:'Spotify',u:'https://www.spotify.com',m:''},
      {i:'16',t:'Twitch',u:'https://www.twitch.tv',m:''}
    ]}
  ];
  settings = {eng:'google',clk:true,tabs:true,nt:true};
  notes = '';
  activeGroup = 0;
  activeCat = '__all__';
  page = 0;
  fails = {};
}

// === HELPERS ===
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function getDom(u) { try { return new URL(u).hostname; } catch(e) { return ''; } }
function getColor(s) { var h=0; for(var i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h); return COLORS[Math.abs(h)%COLORS.length]; }
function favicon(u) { return 'https://www.google.com/s2/favicons?domain='+getDom(u)+'&sz=32'; }
function screenshot(u) { return 'https://image.thum.io/get/width/400/'+u; }
function getCachedImg(d) {
  if (d.img) return d.img;
  return screenshot(d.u) + '?t=' + (d._lt || (d._lt = Date.now()));
}
// Cache image URL into dial data when it loads successfully (debounced save)
var _cacheTimer = null;
function _cacheImg(dialId, url) {
  // Find the dial and store the URL
  for (var gi = 0; gi < groups.length; gi++) {
    for (var di = 0; di < groups[gi].d.length; di++) {
      if (groups[gi].d[di].i === dialId && !groups[gi].d[di].img) {
        // Strip cache-bust param for storage
        groups[gi].d[di].img = url.split('?t=')[0];
        // Debounced save to avoid many writes
        clearTimeout(_cacheTimer);
        _cacheTimer = setTimeout(function() { save(); }, 3000);
        return;
      }
    }
  }
}
function curGroup() { return groups[activeGroup]; }

function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('v');
  clearTimeout(t._to);
  t._to = setTimeout(function() { t.classList.remove('v'); }, 2000);
}

function save() { driveSave(); }

function load() { defaults(); }

// === MODAL ===
function showModal(html, wide) {
  var ov = document.getElementById('overlay');
  ov.innerHTML = '<div class="mpanel' + (wide ? ' wide' : '') + '">' + html + '</div>';
  ov.classList.add('open');
  ov.onclick = function(e) { if (e.target === ov) closeModal(); };
  var panel = ov.querySelector('.mpanel');
  if (panel) panel.onclick = function(e) { e.stopPropagation(); };
}

function closeModal() {
  var ov = document.getElementById('overlay');
  ov.classList.remove('open');
  ov.innerHTML = '';
}

// === RENDER ===
function getCategories() {
  var cats = [];
  groups.forEach(function(g) {
    var c = g.cat || '';
    if (c && cats.indexOf(c) === -1) cats.push(c);
  });
  cats.sort();
  return cats;
}

function renderGroups() {
  var cats = getCategories();
  var catBar = document.getElementById('catBar');
  
  // Only show category bar if there are categories
  if (cats.length > 0) {
    catBar.style.display = 'flex';
    catBar.innerHTML = '';

    // Helper to make a cat button a drop target
    function makeCatDropTarget(el, catValue) {
      el.addEventListener('dragover', function(e) {
        e.preventDefault();
        el.style.background = 'rgba(124,131,255,.3)';
        el.style.transform = 'scale(1.08)';
      });
      el.addEventListener('dragleave', function() {
        el.style.background = '';
        el.style.transform = '';
      });
      el.addEventListener('drop', function(e) {
        e.preventDefault();
        el.style.background = '';
        el.style.transform = '';
        var data = e.dataTransfer.getData('text/plain');
        if (data.indexOf('group:') === 0) {
          var idx = parseInt(data.slice(6));
          groups[idx].cat = catValue;
          save(); renderGroups(); renderDials();
          toast(groups[idx].n + ' → ' + (catValue || 'nincs kategória'));
        }
      });
    }

    // "Összes" button (filter only, not a drop target)
    var allBtn = document.createElement('button');
    allBtn.className = 'cat-btn' + (activeCat === '__all__' ? ' on' : '');
    allBtn.textContent = 'Összes (' + groups.length + ')';
    allBtn.onclick = function() { activeCat = '__all__'; renderGroups(); };
    catBar.appendChild(allBtn);

    // "Nincs kategória" button - also drop target to remove category
    var uncatCount = groups.filter(function(g) { return !g.cat; }).length;
    if (uncatCount > 0 || true) { // always show so user can drop to uncategorize
      var uncatBtn = document.createElement('button');
      uncatBtn.className = 'cat-btn' + (activeCat === '__none__' ? ' on' : '');
      uncatBtn.textContent = 'Nincs (' + uncatCount + ')';
      uncatBtn.style.borderBottom = '2px dashed rgba(255,92,108,.3)';
      uncatBtn.onclick = function() { activeCat = '__none__'; renderGroups(); };
      makeCatDropTarget(uncatBtn, '');
      catBar.appendChild(uncatBtn);
    }

    cats.forEach(function(cat) {
      var count = groups.filter(function(g) { return g.cat === cat; }).length;
      var btn = document.createElement('button');
      btn.className = 'cat-btn' + (activeCat === cat ? ' on' : '');
      btn.textContent = cat + ' (' + count + ')';
      btn.style.borderBottom = '2px dashed rgba(124,131,255,.2)';
      btn.onclick = function() { activeCat = cat; renderGroups(); };
      makeCatDropTarget(btn, cat);
      catBar.appendChild(btn);
    });
  } else {
    catBar.style.display = 'none';
  }

  // Filter groups by active category
  var filteredIndices = [];
  groups.forEach(function(g, i) {
    if (activeCat === '__all__') { filteredIndices.push(i); }
    else if (activeCat === '__none__' && !g.cat) { filteredIndices.push(i); }
    else if (g.cat === activeCat) { filteredIndices.push(i); }
  });

  var c = document.getElementById('groupTabs');
  c.innerHTML = '';
  filteredIndices.forEach(function(i) {
    var g = groups[i];
    var b = document.createElement('button');
    b.className = 'tab' + (i === activeGroup ? ' on' : '');
    b.innerHTML = esc(g.n) + ' <span style="font-size:10px;opacity:.6">(' + g.d.length + ')</span>';
    if (i === activeGroup) { b.style.background = g.c; b.style.borderColor = g.c; }
    b.onclick = function() { activeGroup = i; page = 0; save(); renderGroups(); renderDials(); };
    // Drag groups to reorder
    b.draggable = true;
    b.dataset.gi = i;
    b.addEventListener('dragstart', function(e) { e.dataTransfer.setData('text/plain', 'group:' + i); b.style.opacity = '0.4'; });
    b.addEventListener('dragend', function() { b.style.opacity = '1'; });
    b.addEventListener('dragover', function(e) { e.preventDefault(); b.style.borderColor = '#7c83ff'; });
    b.addEventListener('dragleave', function() { b.style.borderColor = ''; });
    b.addEventListener('drop', function(e) {
      e.preventDefault(); b.style.borderColor = '';
      var data = e.dataTransfer.getData('text/plain');
      if (data.indexOf('group:') === 0) {
        var fromIdx = parseInt(data.slice(6));
        var toIdx = i;
        if (fromIdx !== toIdx) {
          var item = groups.splice(fromIdx, 1)[0];
          groups.splice(toIdx, 0, item);
          if (activeGroup === fromIdx) activeGroup = toIdx;
          else if (fromIdx < activeGroup && toIdx >= activeGroup) activeGroup--;
          else if (fromIdx > activeGroup && toIdx <= activeGroup) activeGroup++;
          save(); renderGroups(); renderDials();
          toast('Csoport áthelyezve');
        }
      }
    });
    c.appendChild(b);
  });
}

function renderDials() {
  var grid = document.getElementById('grid');
  var g = curGroup();
  if (!g) return;
  grid.innerHTML = '';
  // Per-group settings with fallback
  var rows = g.rows || 3;
  var cols = g.cols || 5;
  var pp = rows * cols;
  var total = Math.max(1, Math.ceil(g.d.length / pp));
  if (page >= total) page = total - 1;
  var dw = g.dw || 220, dh = g.dh || 170;
  // Auto-fit: calc available width, shrink dw if needed to fit cols
  var gap = 16;
  var pad = 48; // 24px * 2
  var avail = window.innerWidth - pad;
  var actualDw = Math.min(dw, Math.floor((avail - gap * (cols - 1)) / cols));
  actualDw = Math.max(100, actualDw);
  var actualDh = Math.round(dh * (actualDw / dw));
  grid.style.gridTemplateColumns = 'repeat(' + cols + ',' + actualDw + 'px)';
  grid.style.justifyContent = 'center';

  var start = page * pp;
  var slice = g.d.slice(start, start + pp);

  slice.forEach(function(d, i) {
    var idx = start + i;
    var el = document.createElement('div');
    el.className = 'dial';
    el.style.width = actualDw + 'px';
    el.style.height = actualDh + 'px';
    var domain = getDom(d.u);
    var letter = (d.t || domain || '?')[0].toUpperCase();
    var col = getColor(domain || d.t || '?');
    var imgSrc = getCachedImg(d);
    var h = '<div class="thumb">';
    if (!fails[d.i]) {
      h += '<img src="' + esc(imgSrc) + '" data-di="' + d.i + '" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';if(typeof fails!==\'undefined\')fails[this.dataset.di]=1" onload="if(!this.dataset.cached){this.dataset.cached=1;_cacheImg(this.dataset.di,this.src)}">';
      h += '<div class="fallback" style="display:none;background:linear-gradient(135deg,' + col + 'cc,' + col + '66);font-size:' + Math.max(28, actualDw * 0.18) + 'px">' + letter + '</div>';
    } else {
      h += '<div class="fallback" style="background:linear-gradient(135deg,' + col + 'cc,' + col + '66);font-size:' + Math.max(28, actualDw * 0.18) + 'px">' + letter + '</div>';
    }
    h += '</div><div class="grad"></div>';
    h += '<button class="refresh-btn" data-dial-idx="' + idx + '" title="Kép frissítése"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>';
    h += '<div class="info"><img src="' + esc(favicon(d.u)) + '" onerror="this.style.display=\'none\'"><span>' + esc(d.t || domain || '?') + '</span></div>';
    el.innerHTML = h;
    // Drag & drop
    el.draggable = true;
    el.dataset.idx = idx;
    el.setAttribute('data-idx', idx);
    el.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', idx);
      el.style.opacity = '0.4';
    });
    el.addEventListener('dragend', function() {
      el.style.opacity = '1';
    });
    el.addEventListener('dragover', function(e) {
      e.preventDefault();
      el.style.borderColor = '#7c83ff';
      el.style.boxShadow = '0 0 12px rgba(124,131,255,.4)';
    });
    el.addEventListener('dragleave', function() {
      el.style.borderColor = '';
      el.style.boxShadow = '';
    });
    el.addEventListener('drop', function(e) {
      e.preventDefault();
      el.style.borderColor = '';
      el.style.boxShadow = '';
      var fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      var toIdx = idx;
      if (fromIdx !== toIdx && !isNaN(fromIdx)) {
        var arr = curGroup().d;
        var item = arr.splice(fromIdx, 1)[0];
        arr.splice(toIdx, 0, item);
        save();
        renderDials();
        toast('Átrendezve');
      }
    });
    el.onclick = function(e) {
      if (e.target.closest('.refresh-btn')) return;
      window.open(d.u, settings.nt ? '_blank' : '_self');
    };
    var refreshBtn = el.querySelector('.refresh-btn');
    if (refreshBtn) {
      refreshBtn.onclick = function(e) {
        e.stopPropagation();
        d.img = '';
        delete fails[d.i];
        save();
        renderDials();
        toast('Kép frissítés...');
      };
    }
    grid.appendChild(el);
  });

  // Add button
  var addEl = document.createElement('div');
  addEl.className = 'dial add';
  addEl.style.width = actualDw + 'px';
  addEl.style.height = actualDh + 'px';
  addEl.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><div style="font-size:11px;color:#606080;margin-top:2px">Új tárcsa</div>';
  addEl.onclick = function() { openDialModal(); };
  grid.appendChild(addEl);

  // Pagination
  var pagi = document.getElementById('pagi');
  pagi.innerHTML = '';
  if (total > 1) {
    var prev = document.createElement('button');
    prev.textContent = '◀';
    prev.disabled = page === 0;
    prev.onclick = function() { page--; renderDials(); };
    pagi.appendChild(prev);
    for (var p = 0; p < total; p++) {
      (function(pp) {
        var b = document.createElement('button');
        b.textContent = pp + 1;
        if (pp === page) b.className = 'on';
        b.onclick = function() { page = pp; renderDials(); };
        pagi.appendChild(b);
      })(p);
    }
    var next = document.createElement('button');
    next.textContent = '▶';
    next.disabled = page >= total - 1;
    next.onclick = function() { page++; renderDials(); };
    pagi.appendChild(next);
  }
}

// === DIAL MODAL ===
function openDialModal(editDial, prefillUrl, prefillTitle) {
  var isEdit = !!editDial;
  var html = '<div class="mhead"><h3>' + (isEdit ? 'Szerkesztés' : 'Új tárcsa') + '</h3><button class="closebtn" onclick="closeModal()">&times;</button></div>';
  html += '<div class="mbody">';
  if (!isEdit && groups.length >= 1) {
    html += '<label>Csoport<select id="fGroup">';
    groups.forEach(function(g, i) {
      html += '<option value="' + i + '"' + (i === activeGroup ? ' selected' : '') + '>' + esc(g.n) + ' (' + g.d.length + ')</option>';
    });
    html += '</select></label>';
  }
  html += '<label>URL<input type="url" id="fUrl" placeholder="https://..." value="' + esc(isEdit ? editDial.u : (prefillUrl || '')) + '"></label>';
  html += '<label>Cím<input type="text" id="fTit" placeholder="Név" value="' + esc(isEdit ? editDial.t : (prefillTitle || '')) + '"></label>';
  html += '<label>Jegyzet<textarea id="fNote" placeholder="Opcionális...">' + (isEdit ? esc(editDial.m || '') : '') + '</textarea></label>';
  if (!isEdit) {
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:10px;margin-top:8px">';
    html += '<div style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#7c83ff;font-size:11px" id="batchToggle">&#9660; Több oldal hozzáadása egyszerre</div>';
    html += '<div id="batchArea" style="display:none;margin-top:8px">';
    html += '<textarea id="fBatch" rows="5" placeholder="Soronként egy URL (cím opcionális, tabulátorral elválasztva):&#10;https://example.com&#10;https://google.com&#9;Google&#10;https://facebook.com&#9;Facebook" style="width:100%;font-size:11px"></textarea>';
    html += '<div style="font-size:10px;color:#606080;margin-top:4px">Soronként egy URL. Opcionálisan tab-bal elválasztva a cím is megadható.</div>';
    html += '</div></div>';
  }
  html += '</div><div class="mfoot"><button class="sbtn" onclick="closeModal()">Mégse</button><button class="pbtn" id="fSave">Mentés</button></div>';
  showModal(html);
  setTimeout(function() {
    document.getElementById('fUrl').focus();
    // Batch toggle
    var batchToggle = document.getElementById('batchToggle');
    if (batchToggle) {
      batchToggle.onclick = function() {
        var area = document.getElementById('batchArea');
        if (area.style.display === 'none') {
          area.style.display = 'block';
          batchToggle.innerHTML = '&#9650; Több oldal hozzáadása egyszerre';
        } else {
          area.style.display = 'none';
          batchToggle.innerHTML = '&#9660; Több oldal hozzáadása egyszerre';
        }
      };
    }
    document.getElementById('fSave').onclick = function() {
      var targetIdx = activeGroup;
      var sel = document.getElementById('fGroup');
      if (sel) targetIdx = parseInt(sel.value);
      // Check batch mode first
      var batchEl = document.getElementById('fBatch');
      var batchText = batchEl ? batchEl.value.trim() : '';
      if (batchText && !isEdit) {
        var lines = batchText.split('\n').filter(function(l) { return l.trim(); });
        var count = 0;
        lines.forEach(function(line) {
          var parts = line.split('\t');
          var u = parts[0].trim();
          var t = parts[1] ? parts[1].trim() : '';
          if (!u) return;
          if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
          if (!t) t = getDom(u) || 'Névtelen';
          groups[targetIdx].d.push({i: uid(), t: t, u: u, m: ''});
          count++;
        });
        if (count > 0) {
          if (targetIdx !== activeGroup) activeGroup = targetIdx;
          save(); renderDials(); renderGroups();
          toast(count + ' oldal hozzáadva: ' + groups[targetIdx].n);
          closeModal();
        } else {
          toast('Nem találtam URL-eket!');
        }
        return;
      }
      // Single URL mode
      var u = document.getElementById('fUrl').value.trim();
      var t = document.getElementById('fTit').value.trim();
      var m = document.getElementById('fNote').value.trim();
      if (!u) { toast('Adj meg URL-t!'); return; }
      if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
      if (!t) t = getDom(u) || 'Névtelen';
      if (isEdit) {
        var g = curGroup();
        var x = g.d.find(function(x) { return x.i === editDial.i; });
        if (x) { x.u = u; x.t = t; x.m = m; }
        toast('Frissítve');
      } else {
        groups[targetIdx].d.push({i: uid(), t: t, u: u, m: m});
        if (targetIdx !== activeGroup) {
          activeGroup = targetIdx;
        }
        toast('Hozzáadva: ' + groups[targetIdx].n);
      }
      save(); renderDials(); renderGroups(); closeModal();
    };
  }, 50);
}

// === TOP SITES ===
function openTopSites() {
  var html = '<div class="mhead"><h3>&#128202; Top oldalak</h3><button class="closebtn" onclick="closeModal()">&times;</button></div><div class="mbody">';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
  SITES.forEach(function(s, i) {
    html += '<div class="tsi" data-idx="' + i + '"><img src="' + favicon(s[1]) + '" onerror="this.style.display=\'none\'"><span class="nm">' + esc(s[0]) + '</span><span class="ad" data-add="' + i + '">+</span></div>';
  });
  html += '</div></div>';
  showModal(html);
  setTimeout(function() {
    document.querySelectorAll('.tsi').forEach(function(el) {
      el.onclick = function() { window.open(SITES[el.dataset.idx][1], '_blank'); };
    });
    document.querySelectorAll('.ad').forEach(function(el) {
      el.onclick = function(e) {
        e.stopPropagation();
        var s = SITES[el.dataset.add];
        curGroup().d.push({i: uid(), t: s[0], u: s[1], m: ''});
        save(); renderDials(); renderGroups(); toast(s[0] + ' hozzáadva');
      };
    });
  }, 50);
}

// === TIMER ===
var timerInterval = null, timerSec = 0, timerRunning = false, timerCountdown = false, cdTarget = 0;

function timerStr() {
  var s = timerCountdown ? Math.max(0, cdTarget - timerSec) : timerSec;
  return [Math.floor(s/3600), Math.floor((s%3600)/60), s%60].map(function(v) { return String(v).padStart(2,'0'); }).join(':');
}

function openTimer() {
  var html = '<div class="mhead"><h3>&#9201; Időzítő</h3><button class="closebtn" onclick="closeModal()">&times;</button></div>';
  html += '<div class="mbody" style="text-align:center">';
  html += '<div class="tmrd" id="tDisp">' + timerStr() + '</div>';
  html += '<div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">';
  html += '<button class="pbtn" id="tStart">&#9654; Indítás</button>';
  html += '<button class="sbtn" id="tPause">&#9208; Szünet</button>';
  html += '<button class="sbtn" id="tReset">&#128260; Reset</button></div>';
  html += '<div style="display:flex;gap:16px;justify-content:center;font-size:12px;margin-bottom:10px">';
  html += '<label><input type="radio" name="tmode" value="sw"' + (!timerCountdown ? ' checked' : '') + '> Stopper</label>';
  html += '<label><input type="radio" name="tmode" value="cd"' + (timerCountdown ? ' checked' : '') + '> Visszaszámláló</label></div>';
  html += '<div id="cdRow" style="display:' + (timerCountdown ? 'flex' : 'none') + ';gap:6px;justify-content:center;align-items:center;font-size:12px">';
  html += '<input type="number" id="cdMin" value="5" min="0" style="width:55px;text-align:center"> perc ';
  html += '<input type="number" id="cdSec" value="0" min="0" max="59" style="width:55px;text-align:center"> mp</div>';
  html += '</div>';
  showModal(html);
  setTimeout(function() {
    document.getElementById('tStart').onclick = function() {
      if (timerRunning) return;
      if (timerCountdown && timerSec === 0) {
        cdTarget = (parseInt(document.getElementById('cdMin').value)||0)*60 + (parseInt(document.getElementById('cdSec').value)||0);
      }
      timerRunning = true;
      timerInterval = setInterval(function() {
        timerSec++;
        var d = document.getElementById('tDisp');
        if (d) d.textContent = timerStr();
        if (timerCountdown && cdTarget - timerSec <= 0) {
          clearInterval(timerInterval); timerRunning = false; toast('⏰ Lejárt!');
        }
      }, 1000);
    };
    document.getElementById('tPause').onclick = function() { clearInterval(timerInterval); timerRunning = false; };
    document.getElementById('tReset').onclick = function() { clearInterval(timerInterval); timerRunning = false; timerSec = 0; cdTarget = 0; var d = document.getElementById('tDisp'); if(d) d.textContent = timerStr(); };
    document.querySelectorAll('input[name=tmode]').forEach(function(r) {
      r.onchange = function() {
        timerCountdown = r.value === 'cd';
        document.getElementById('cdRow').style.display = timerCountdown ? 'flex' : 'none';
        clearInterval(timerInterval); timerRunning = false; timerSec = 0; cdTarget = 0;
        var d = document.getElementById('tDisp'); if(d) d.textContent = timerStr();
      };
    });
  }, 50);
}

// === NOTES ===
function openNotes() {
  var html = '<div class="mhead"><h3>&#128221; Jegyzetek</h3><button class="closebtn" onclick="closeModal()">&times;</button></div>';
  html += '<div class="mbody"><textarea id="nArea" style="min-height:200px;width:100%;resize:vertical" placeholder="Jegyzeteid...">' + esc(notes) + '</textarea></div>';
  html += '<div class="mfoot"><button class="sbtn" onclick="closeModal()">Bezárás</button><button class="pbtn" id="nSave">Mentés</button></div>';
  showModal(html);
  setTimeout(function() {
    document.getElementById('nSave').onclick = function() {
      notes = document.getElementById('nArea').value;
      save(); toast('Mentve'); closeModal();
    };
  }, 50);
}

// === SETTINGS ===
var sTab = 'general';
function openSettings() {
  var s = settings;
  var html = '<div class="mhead"><h3>&#9881; Beállítások</h3><button class="closebtn" onclick="closeModal()">&times;</button></div><div class="mbody">';
  html += '<div class="stabs">';
  [['general','Általános'],['dials','Tárcsák'],['look','Megjelenés'],['groups','Csoportok'],['search','Keresés'],['data','Adatok']].forEach(function(x) {
    html += '<button class="stab' + (sTab === x[0] ? ' on' : '') + '" data-st="' + x[0] + '">' + x[1] + '</button>';
  });
  html += '</div>';

  if (sTab === 'general') {
    html += '<div class="srow"><span style="font-size:12px;font-weight:500">Óra</span><input type="checkbox" id="xClk"' + (s.clk ? ' checked' : '') + ' style="width:18px;height:18px;accent-color:#7c83ff"></div>';
    html += '<div class="srow"><span style="font-size:12px;font-weight:500">Csoportfülek</span><input type="checkbox" id="xTabs"' + (s.tabs ? ' checked' : '') + ' style="width:18px;height:18px;accent-color:#7c83ff"></div>';
    html += '<div class="srow"><span style="font-size:12px;font-weight:500">Új fülön nyitás</span><input type="checkbox" id="xNt"' + (s.nt ? ' checked' : '') + ' style="width:18px;height:18px;accent-color:#7c83ff"></div>';
    html += '<div class="rng"><div class="rh"><span style="font-size:12px">Csoportfülek max sorai</span><span class="rv" id="sv_tabRows">' + (s.tabRows||3) + '</span></div>';
    html += '<input type="range" id="sr_tabRows" min="1" max="10" value="' + (s.tabRows||3) + '"></div>';
  }
  if (sTab === 'dials') {
    var cg = curGroup();
    html += '<div style="font-size:11px;color:#606080;margin-bottom:10px">Beállítások a(z) <b style="color:#7c83ff">' + esc(cg.n) + '</b> csoporthoz</div>';
    [['cols','Oszlopok',2,10,cg.cols||5],['rows','Sorok',1,10,cg.rows||3],['dw','Szélesség (px)',120,400,cg.dw||220],['dh','Magasság (px)',100,350,cg.dh||170]].forEach(function(x) {
      html += '<div class="rng"><div class="rh"><span style="font-size:12px">' + x[1] + '</span><span class="rv" id="sv_' + x[0] + '">' + x[4] + '</span></div>';
      html += '<input type="range" id="sr_' + x[0] + '" min="' + x[2] + '" max="' + x[3] + '" value="' + x[4] + '"></div>';
    });
    html += '<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"><button class="sbtn" id="copySettingsAll" style="font-size:11px;padding:4px 10px">Alkalmazás minden csoportra</button>';
    html += '<button class="sbtn" id="refreshAllImgs" style="font-size:11px;padding:4px 10px">Összes kép frissítése</button>';
    html += '<button class="sbtn" id="refreshGroupImgs" style="font-size:11px;padding:4px 10px">Csoport képeinek frissítése</button></div>';
  }
  if (sTab === 'look') {
    var lk = settings.look || {};
    // Font family
    var fonts = [['system-ui, sans-serif','Rendszer (alapértelmezett)'],['Arial, sans-serif','Arial'],['Calibri, sans-serif','Calibri'],['Inter, sans-serif','Inter'],['Roboto, sans-serif','Roboto'],['Poppins, sans-serif','Poppins'],['Nunito, sans-serif','Nunito'],['Fira Sans, sans-serif','Fira Sans'],['Source Sans Pro, sans-serif','Source Sans Pro'],['Montserrat, sans-serif','Montserrat'],['Lato, sans-serif','Lato'],['Open Sans, sans-serif','Open Sans'],['Raleway, sans-serif','Raleway'],['Quicksand, sans-serif','Quicksand'],['Comfortaa, sans-serif','Comfortaa'],['Josefin Sans, sans-serif','Josefin Sans'],['Work Sans, sans-serif','Work Sans'],['Rubik, sans-serif','Rubik'],['Cabin, sans-serif','Cabin'],['Karla, sans-serif','Karla'],['Barlow, sans-serif','Barlow'],['DM Sans, sans-serif','DM Sans'],['IBM Plex Sans, sans-serif','IBM Plex Sans'],['Outfit, sans-serif','Outfit'],['Manrope, sans-serif','Manrope'],['Space Grotesk, sans-serif','Space Grotesk'],['Times New Roman, serif','Times New Roman'],['Georgia, serif','Georgia'],['serif','Talpas (serif)'],['monospace','Monospace'],['Fira Code, monospace','Fira Code'],['JetBrains Mono, monospace','JetBrains Mono']];
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:6px">Betűtípus</div>';
    html += '<select id="lkFont" style="width:100%;padding:6px 8px;margin-bottom:14px;font-size:12px;background:#1c1c35;color:#e8e8f0;border:1px solid rgba(124,131,255,.15);border-radius:6px">';
    fonts.forEach(function(f) {
      html += '<option value="' + f[0] + '"' + ((lk.font||'system-ui, sans-serif') === f[0] ? ' selected' : '') + ' style="font-family:' + f[0] + '">' + f[1] + '</option>';
    });
    html += '</select>';
    // Font sizes
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:8px">Betűméretek</div>';
    [['fsTab','Fülcímkék (px)',9,18,lk.fsTab||13],['fsDial','Tárcsacím (px)',8,16,lk.fsDial||11],['fsCat','Kategória (px)',9,16,lk.fsCat||11],['fsLogo','Logo (px)',12,24,lk.fsLogo||15]].forEach(function(x) {
      html += '<div class="rng"><div class="rh"><span style="font-size:12px">' + x[1] + '</span><span class="rv" id="sv_' + x[0] + '">' + x[4] + '</span></div>';
      html += '<input type="range" id="sr_' + x[0] + '" min="' + x[2] + '" max="' + x[3] + '" value="' + x[4] + '"></div>';
    });
    // Font weight
    html += '<div style="margin-top:8px"><div style="font-size:12px;font-weight:500;margin-bottom:6px">Tárcsacím vastagság</div>';
    html += '<select id="lkFw" style="padding:4px 8px;font-size:12px;background:#1c1c35;color:#e8e8f0;border:1px solid rgba(124,131,255,.15);border-radius:6px">';
    [['400','Normál'],['500','Közepes'],['600','Félkövér'],['700','Kövér']].forEach(function(w) {
      html += '<option value="' + w[0] + '"' + ((lk.fw||'600') === w[0] ? ' selected' : '') + '>' + w[1] + '</option>';
    });
    html += '</select></div>';
    // Font colors
    html += '<div style="margin-top:12px"><div style="font-size:12px;font-weight:500;margin-bottom:8px">Betűszínek</div>';
    [['fcTab','Fülcímkék',lk.fcTab||'#9090b0'],['fcDial','Tárcsacím',lk.fcDial||'#ffffff'],['fcCat','Kategória',lk.fcCat||'#606080'],['fcLogo','Logo',lk.fcLogo||'#7c83ff']].forEach(function(x) {
      html += '<div class="srow" style="padding:3px 0"><span style="font-size:11px">' + x[1] + '</span><input type="color" id="lk_' + x[0] + '" value="' + x[2] + '" style="width:28px;height:28px;border:none;cursor:pointer"></div>';
    });
    html += '</div>';
    // Dial shape
    html += '<div style="margin-top:12px"><div style="font-size:12px;font-weight:500;margin-bottom:6px">Tárcsa alakja</div>';
    html += '<div class="rng"><div class="rh"><span style="font-size:12px">Lekerekítés (px)</span><span class="rv" id="sv_dialRadius">' + (lk.dialRadius||12) + '</span></div>';
    html += '<input type="range" id="sr_dialRadius" min="0" max="32" value="' + (typeof lk.dialRadius==='number'?lk.dialRadius:12) + '"></div>';
    html += '<div style="display:flex;gap:8px;margin-top:6px">';
    [['0','Szögletes'],['6','Enyhén'],['12','Közepes'],['20','Kerek'],['32','Nagyon kerek']].forEach(function(x) {
      var cur = typeof lk.dialRadius==='number'?lk.dialRadius:12;
      html += '<button class="sbtn dial-shape-btn" data-dr="' + x[0] + '" style="padding:3px 8px;font-size:10px;border-radius:' + x[0] + 'px' + (cur==parseInt(x[0])?' ;background:rgba(124,131,255,.2);color:#7c83ff':'') + '">' + x[1] + '</button>';
    });
    html += '</div></div>';
    // Preview
    html += '<div style="margin-top:14px;padding:12px;border:1px solid rgba(124,131,255,.15);border-radius:8px;text-align:center" id="lkPreview">';
    html += '<div style="font-size:11px;color:#606080;margin-bottom:4px">Előnézet</div>';
    html += '<div id="lkPrevText" style="font-family:' + (lk.font||'system-ui, sans-serif') + '">Speed Dial Groups — 0123456789</div>';
    html += '</div>';
  }
  if (sTab === 'groups') {
    // Category management
    var cats = getCategories();
    html += '<div style="margin-bottom:12px">';
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:6px">Kategóriák <span style="font-size:10px;color:#606080;font-weight:400">— húzd a csoportokat ide</span></div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px" id="catDropZone">';
    // "No category" drop target
    var uncatCnt = groups.filter(function(g) { return !g.cat; }).length;
    html += '<div class="cat-drop" data-catdrop="" style="font-size:11px;padding:6px 12px;background:rgba(255,92,108,.08);border:2px dashed rgba(255,92,108,.2);border-radius:6px;color:#ff5c6c;cursor:default;transition:all .2s">Nincs (' + uncatCnt + ')</div>';
    if (cats.length > 0) {
      cats.forEach(function(c) {
        var cnt = groups.filter(function(g) { return g.cat === c; }).length;
        html += '<div class="cat-drop" data-catdrop="' + esc(c) + '" style="font-size:11px;padding:6px 12px;background:rgba(124,131,255,.08);border:2px dashed rgba(124,131,255,.2);border-radius:6px;color:#7c83ff;cursor:default;transition:all .2s">' + esc(c) + ' (' + cnt + ')</div>';
      });
    }
    html += '</div>';
    html += '<div style="display:flex;gap:4px"><input type="text" id="newCatInput" placeholder="Új kategória neve..." style="flex:1;font-size:11px;padding:4px 8px"><button class="sbtn" id="addCatBtn" style="padding:3px 8px;font-size:11px">Hozzáadás</button></div>';
    html += '</div>';
    // Bulk categorization
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:10px;margin-bottom:10px">';
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:6px">Tömeges kategorizálás</div>';
    html += '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:8px">';
    html += '<select id="bulkCatSel" style="font-size:12px;padding:4px 8px;background:#1c1c35;color:#e8e8f0;border:1px solid rgba(124,131,255,.15);border-radius:6px;min-width:140px"><option value="">(válassz kategóriát)</option>';
    cats.forEach(function(c) { html += '<option value="' + esc(c) + '">' + esc(c) + '</option>'; });
    html += '</select>';
    html += '<button class="pbtn" id="bulkApplyBtn" style="font-size:11px;padding:4px 12px">Alkalmazás kijelöltekre</button>';
    html += '<button class="sbtn" id="bulkClearBtn" style="font-size:11px;padding:4px 8px;color:#ff5c6c">Kategória eltávolítása</button>';
    html += '</div>';
    html += '<div style="display:flex;gap:6px;margin-bottom:8px">';
    html += '<button class="sbtn" id="bulkSelAll" style="font-size:10px;padding:2px 8px">Mind kijelöl</button>';
    html += '<button class="sbtn" id="bulkSelNone" style="font-size:10px;padding:2px 8px">Kijelölés törlése</button>';
    html += '<button class="sbtn" id="bulkSelUncat" style="font-size:10px;padding:2px 8px">Csak kategorizálatlanok</button>';
    html += '</div>';
    html += '</div>';
    // Group list with checkboxes - draggable rows
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:8px;max-height:400px;overflow-y:auto" id="grpList">';
    groups.forEach(function(g, i) {
      var isHome = (settings.homeGroup === i) || (!settings.homeGroup && i === 0);
      html += '<div class="srow grp-drag" draggable="true" data-grpi="' + i + '" style="flex-wrap:wrap;padding:5px 0;min-height:0;cursor:grab;transition:opacity .2s">';
      html += '<div style="display:flex;align-items:center;gap:6px;flex:1;min-width:0">';
      html += '<span style="color:#404060;font-size:10px;cursor:grab;flex-shrink:0" title="Húzd egy kategóriára">&#9776;</span>';
      html += '<input type="checkbox" class="bulk-cb" data-bi="' + i + '" style="width:16px;height:16px;accent-color:#7c83ff;flex-shrink:0">';
      html += '<input type="color" value="' + g.c + '" data-gc="' + i + '" style="width:20px;height:20px;border:none;cursor:pointer;flex-shrink:0">';
      html += '<div style="min-width:0;overflow:hidden"><span style="font-size:11px;font-weight:500;white-space:nowrap">' + esc(g.n) + (isHome ? ' &#127968;' : '') + '</span>';
      html += '<div style="font-size:9px;color:#606080">' + g.d.length + ' db' + (g.cat ? ' · <span style="color:#7c83ff">' + esc(g.cat) + '</span>' : ' · <i>nincs kategória</i>') + '</div></div></div>';
      html += '<div style="display:flex;gap:3px;flex-shrink:0">';
      html += '<select data-gcat="' + i + '" style="font-size:10px;padding:1px 3px;background:#1c1c35;color:#9090b0;border:1px solid rgba(124,131,255,.15);border-radius:4px;max-width:90px"><option value="">(nincs)</option>';
      cats.forEach(function(c) { html += '<option value="' + esc(c) + '"' + (g.cat === c ? ' selected' : '') + '>' + esc(c) + '</option>'; });
      html += '</select>';
      if (!isHome) html += '<button class="sbtn" style="padding:2px 6px;font-size:10px" data-ghome="' + i + '" title="Kezdőlap">&#127968;</button>';
      html += '<button class="sbtn" style="padding:2px 6px;font-size:10px" data-gren="' + i + '">&#9998;</button>';
      html += '<button class="sbtn" style="padding:2px 6px;font-size:10px;color:#ff5c6c" data-gdel="' + i + '">&#10005;</button>';
      html += '</div></div>';
    });
    html += '</div>';
  }
  if (sTab === 'search') {
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:8px">Keresőmotor</div>';
    Object.keys(ENGINES).forEach(function(k) {
      var n = k === 'ddg' ? 'DuckDuckGo' : k[0].toUpperCase() + k.slice(1);
      html += '<label style="display:flex;align-items:center;gap:8px;padding:7px;cursor:pointer;border-radius:6px;margin-bottom:2px;' + (s.eng === k ? 'background:rgba(124,131,255,.1)' : '') + '"><input type="radio" name="xEng" value="' + k + '"' + (s.eng === k ? ' checked' : '') + '><span style="font-size:13px">' + n + '</span></label>';
    });
  }
  if (sTab === 'data') {
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:12px">Export / Import</div>';
    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px"><button class="pbtn" id="exportBtn" style="font-size:12px">&#128190; Export JSON</button><button class="sbtn" id="importBtn" style="font-size:12px">&#128194; Import JSON</button><button class="pbtn" id="exportHtmlBtn" style="font-size:12px;background:#2ecc71">&#127760; Export HTML</button><button class="sbtn" id="importHtmlBtn" style="font-size:12px">&#127760; Import HTML</button></div>';
    html += '<input type="file" id="importFile" accept=".json" style="display:none">';
    html += '<input type="file" id="importHtmlFile" accept=".html,.htm" style="display:none">';
    html += '<div style="font-size:11px;color:#606080;margin-bottom:16px"><b>JSON</b>: csak az adatok (csoportok, tárcsák, beállítások, jegyzetek).<br><b>HTML</b>: a teljes alkalmazás az adatokkal együtt — offline is megnyitható!</div>';
    // Browser bookmarks import
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:12px;margin-bottom:16px">';
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:8px">&#128278; Böngésző könyvjelzők importálása</div>';
    html += '<div style="font-size:11px;color:#606080;margin-bottom:8px">Importáld a böngésződből exportált könyvjelzőket (bookmarks.html). A mappák csoportokká válnak.</div>';
    html += '<button class="pbtn" id="importBookmarksBtn" style="font-size:12px;background:#e67e22">&#128214; Könyvjelzők importálása</button>';
    html += '<button class="sbtn" id="exportBookmarksBtn" style="font-size:12px;margin-left:4px">&#128214; Könyvjelzők exportálása</button>';
    html += '<input type="file" id="importBookmarksFile" accept=".html,.htm" style="display:none">';
    html += '<div style="margin-top:6px"><label style="font-size:11px;color:#9090b0;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="bmReplace" style="accent-color:#7c83ff"> Meglévő csoportok felülírása</label></div>';
    html += '</div>';
    // Bookmarklet
    var bmUrl = window.location.origin + window.location.pathname;
    var bmCode = "javascript:void(window.open('" + bmUrl + "?add='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title)))";
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:12px;margin-bottom:16px">';
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:8px">&#128278; Oldal hozzáadása bookmarklet</div>';
    html += '<div style="font-size:11px;color:#606080;margin-bottom:8px">Húzd ezt a gombot a könyvjelzősávra. Bármilyen oldalon rákattintva hozzáadhatod a Speed Dial-hoz:</div>';
    html += '<a href="' + esc(bmCode) + '" onclick="event.preventDefault();toast(\'Húzd a könyvjelzősávra!\')" style="display:inline-block;padding:8px 16px;background:#7c83ff;color:#fff;border-radius:8px;text-decoration:none;font-size:12px;font-weight:600;cursor:grab">&#10133; Speed Dial</a>';
    html += '<div style="font-size:10px;color:#606080;margin-top:6px">Tipp: ha nem látod a könyvjelzősávot, nyomj Ctrl+Shift+B</div>';
    html += '</div>';
    // Reset
    html += '<div style="border-top:1px solid rgba(124,131,255,.1);padding-top:12px">';
    html += '<div style="font-size:12px;font-weight:500;margin-bottom:8px;color:#ff5c6c">Veszélyes zóna</div>';
    html += '<button class="sbtn" id="resetBtn" style="font-size:11px;color:#ff5c6c;border-color:rgba(255,92,108,.3)">&#128465; Összes adat törlése</button>';
    html += '</div>';
  }
  html += '</div><div class="mfoot"><button class="sbtn" onclick="closeModal()">Bezárás</button><button class="pbtn" id="setSave">Mentés</button></div>';
  showModal(html, true);

  setTimeout(function() {
    // Tab switching
    document.querySelectorAll('[data-st]').forEach(function(b) {
      b.onclick = function() { sTab = b.dataset.st; openSettings(); };
    });
    // Sliders live
    ['cols','rows','dw','dh','fsTab','fsDial','fsCat','fsLogo','tabRows','dialRadius'].forEach(function(k) {
      var sl = document.getElementById('sr_' + k);
      var sv = document.getElementById('sv_' + k);
      if (sl && sv) {
        sl.oninput = function() {
          sv.textContent = sl.value;
          // Live preview for font sizes
          var prev = document.getElementById('lkPrevText');
          if (prev && k.indexOf('fs') === 0) prev.style.fontSize = sl.value + 'px';
        };
      }
    });
    // Font family live preview
    var fontSel = document.getElementById('lkFont');
    if (fontSel) {
      fontSel.onchange = function() {
        var prev = document.getElementById('lkPrevText');
        if (prev) prev.style.fontFamily = fontSel.value;
      };
    }
    // Dial shape preset buttons
    document.querySelectorAll('.dial-shape-btn').forEach(function(btn) {
      btn.onclick = function() {
        var v = parseInt(btn.dataset.dr);
        var sl = document.getElementById('sr_dialRadius');
        var sv = document.getElementById('sv_dialRadius');
        if (sl) { sl.value = v; }
        if (sv) { sv.textContent = v; }
      };
    });
    // Copy settings to all groups
    // Refresh images buttons
    var refAll = document.getElementById('refreshAllImgs');
    if (refAll) {
      refAll.onclick = function() {
        var count = 0;
        groups.forEach(function(g) { g.d.forEach(function(d) { d.img = ''; delete fails[d.i]; count++; }); });
        save(); renderDials(); toast(count + ' kép frissítés...');
      };
    }
    var refGrp = document.getElementById('refreshGroupImgs');
    if (refGrp) {
      refGrp.onclick = function() {
        var g = curGroup();
        g.d.forEach(function(d) { d.img = ''; delete fails[d.i]; });
        save(); renderDials(); toast(g.d.length + ' kép frissítés...');
      };
    }
    var csBtn = document.getElementById('copySettingsAll');
    if (csBtn) {
      csBtn.onclick = function() {
        var v = function(id) { return document.getElementById(id); };
        var nc = parseInt(v('sr_cols').value)||5, nr = parseInt(v('sr_rows').value)||3, nw = parseInt(v('sr_dw').value)||220, nh = parseInt(v('sr_dh').value)||170;
        groups.forEach(function(g) { g.cols = nc; g.rows = nr; g.dw = nw; g.dh = nh; });
        save(); toast('Minden csoportra alkalmazva');
      };
    }
    // Export
    var expBtn = document.getElementById('exportBtn');
    if (expBtn) {
      expBtn.onclick = function() {
        var data = JSON.stringify({groups: groups, settings: settings, notes: notes, activeGroup: activeGroup, version: '3.0'}, null, 2);
        var blob = new Blob([data], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'speed-dial-backup-' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
        toast('Exportálva');
      };
    }
    // Import
    var impBtn = document.getElementById('importBtn');
    var impFile = document.getElementById('importFile');
    if (impBtn && impFile) {
      impBtn.onclick = function() { impFile.click(); };
      impFile.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(ev) {
          try {
            var data = JSON.parse(ev.target.result);
            if (!data.groups || !Array.isArray(data.groups)) { toast('Hibás fájl!'); return; }
            if (confirm('Importálás? Ez felülírja a jelenlegi adatokat!')) {
              groups = data.groups;
              if (data.settings) settings = Object.assign(settings, data.settings);
              if (data.notes !== undefined) notes = data.notes;
              if (typeof data.activeGroup === 'number') activeGroup = data.activeGroup;
              if (activeGroup >= groups.length) activeGroup = 0;
              page = 0;
              save(); applySettings(); renderGroups(); renderDials();
              toast('Importálva: ' + groups.length + ' csoport');
              closeModal();
            }
          } catch(err) { toast('Hibás JSON fájl!'); }
        };
        reader.readAsText(file);
      };
    }
    // HTML Export
    var expHtmlBtn = document.getElementById('exportHtmlBtn');
    if (expHtmlBtn) {
      expHtmlBtn.onclick = function() {
        // Encode data as base64 to avoid any parsing issues
        var dataObj = {groups: groups, settings: settings, notes: notes, activeGroup: activeGroup};
        var dataB64 = btoa(unescape(encodeURIComponent(JSON.stringify(dataObj))));
        // Get full page source
        var pageHtml = document.documentElement.outerHTML;
        // Insert a data tag right before </head>
        var dataTag = '<script id="sd-embedded-data" type="application/json">' + dataB64 + '</' + 'script>';
        pageHtml = pageHtml.replace('</head>', dataTag + '\n</head>');
        // Also inject loader code that reads the embedded data on load
        var loaderCode = '\n// === LOAD EMBEDDED DATA ===\n(function(){var el=document.getElementById("sd-embedded-data");if(el){try{var d=JSON.parse(decodeURIComponent(escape(atob(el.textContent.trim()))));if(d&&d.groups){groups=d.groups;if(d.settings)settings=Object.assign(settings,d.settings);if(d.notes!==undefined)notes=d.notes;if(typeof d.activeGroup==="number")activeGroup=d.activeGroup;if(activeGroup>=groups.length)activeGroup=0;page=0;}}catch(e){console.error("Embedded data error:",e);}}})();\n';
        var marker = '// === INIT ===';
        pageHtml = pageHtml.replace(marker, loaderCode + marker);
        var blob = new Blob(['<!DOCTYPE html>\n<html' + pageHtml.slice(pageHtml.indexOf('<html') + 5)], {type: 'text/html'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'speed-dial-' + new Date().toISOString().slice(0,10) + '.html';
        a.click();
        URL.revokeObjectURL(a.href);
        toast('HTML exportálva');
      };
    }
    // HTML Import
    var impHtmlBtn = document.getElementById('importHtmlBtn');
    var impHtmlFile = document.getElementById('importHtmlFile');
    if (impHtmlBtn && impHtmlFile) {
      impHtmlBtn.onclick = function() { impHtmlFile.click(); };
      impHtmlFile.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(ev) {
          try {
            var htmlStr = ev.target.result;
            var data = null;
            // Method 1: Look for base64 encoded data in sd-embedded-data tag
            var b64Match = htmlStr.match(/id="sd-embedded-data"[^>]*>([^<]+)</);
            if (b64Match) {
              try {
                data = JSON.parse(decodeURIComponent(escape(atob(b64Match[1].trim()))));
              } catch(e) { console.error('Base64 decode error:', e); }
            }
            // Method 2: Look for old-style _embedded variable
            if (!data) {
              var embMatch = htmlStr.match(/var _embedded\s*=\s*(\{[\s\S]*?\});/);
              if (embMatch) {
                try { data = JSON.parse(embMatch[1]); } catch(e) {}
              }
            }
            // Method 3: Try to find JSON with groups array
            if (!data) {
              var gMatch = htmlStr.match(/"groups"\s*:\s*\[/);
              if (gMatch) {
                var searchStart = Math.max(0, gMatch.index - 50);
                var chunk = htmlStr.slice(searchStart, Math.min(htmlStr.length, searchStart + 500000));
                var braceStart = chunk.indexOf('{');
                if (braceStart >= 0) {
                  var depth = 0;
                  for (var ci = braceStart; ci < chunk.length; ci++) {
                    if (chunk[ci] === '{') depth++;
                    if (chunk[ci] === '}') { depth--; if (depth === 0) { try { data = JSON.parse(chunk.slice(braceStart, ci + 1)); } catch(e) {} break; } }
                  }
                }
              }
            }
            if (!data || !data.groups || !Array.isArray(data.groups)) {
              toast('Nem találhatók adatok a HTML-ben!');
              return;
            }
            if (confirm('Importálás HTML-ből? Ez felülírja a jelenlegi adatokat!')) {
              groups = data.groups;
              if (data.settings) settings = Object.assign(settings, data.settings);
              if (data.notes !== undefined) notes = data.notes;
              if (typeof data.activeGroup === 'number') activeGroup = data.activeGroup;
              if (activeGroup >= groups.length) activeGroup = 0;
              page = 0;
              save(); applySettings(); renderGroups(); renderDials();
              toast('HTML importálva: ' + groups.length + ' csoport');
              closeModal();
            }
          } catch(err) { toast('Hiba a HTML feldolgozásakor!'); console.error(err); }
        };
        reader.readAsText(file);
      };
    }
    // Browser Bookmarks Import
    var bmBtn = document.getElementById('importBookmarksBtn');
    var bmFile = document.getElementById('importBookmarksFile');
    if (bmBtn && bmFile) {
      bmBtn.onclick = function() { bmFile.click(); };
      bmFile.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(ev) {
          try {
            var htm = ev.target.result;
            var parser = new DOMParser();
            var doc = parser.parseFromString(htm, 'text/html');
            var newGroups = [];
            function parseFolder(dl, folderName) {
              var items = dl.children;
              var dials = [];
              for (var ci = 0; ci < items.length; ci++) {
                var dt = items[ci];
                if (dt.tagName !== 'DT') continue;
                var h3 = dt.querySelector(':scope > H3');
                var a = dt.querySelector(':scope > A');
                var subDl = dt.querySelector(':scope > DL');
                if (h3 && subDl) {
                  parseFolder(subDl, h3.textContent.trim());
                } else if (a) {
                  var href = a.getAttribute('HREF') || a.getAttribute('href') || '';
                  var title = a.textContent.trim();
                  if (href && /^https?:\/\//i.test(href)) {
                    dials.push({i: uid(), t: title, u: href, m: ''});
                  }
                }
              }
              if (dials.length > 0 && folderName) {
                newGroups.push({n: folderName, c: COLORS[newGroups.length % COLORS.length], cols: 5, dw: 220, dh: 170, pp: 15, d: dials});
              }
            }
            var rootDl = doc.querySelector('DL');
            if (!rootDl) { toast('Nem található könyvjelző struktúra!'); return; }
            var topItems = rootDl.children;
            for (var ti = 0; ti < topItems.length; ti++) {
              var dt = topItems[ti];
              if (dt.tagName !== 'DT') continue;
              var h3 = dt.querySelector(':scope > H3');
              var a = dt.querySelector(':scope > A');
              var subDl = dt.querySelector(':scope > DL');
              if (h3 && subDl) {
                parseFolder(subDl, h3.textContent.trim());
              } else if (a) {
                var href = a.getAttribute('HREF') || a.getAttribute('href') || '';
                var title = a.textContent.trim();
                if (href && /^https?:\/\//i.test(href)) {
                  var misc = newGroups.find(function(g) { return g.n === 'Egyéb'; });
                  if (!misc) { misc = {n: 'Egyéb', c: '#95a5a6', cols: 5, dw: 220, dh: 170, pp: 15, d: []}; newGroups.push(misc); }
                  misc.d.push({i: uid(), t: title, u: href, m: ''});
                }
              }
            }
            if (newGroups.length === 0) { toast('Nincsenek importálható könyvjelzők!'); return; }
            var totalDials = newGroups.reduce(function(s, g) { return s + g.d.length; }, 0);
            var replaceMode = document.getElementById('bmReplace') && document.getElementById('bmReplace').checked;
            if (confirm('Importálás: ' + newGroups.length + ' csoport, ' + totalDials + ' könyvjelző.\n' + (replaceMode ? 'A meglévő csoportok felülíródnak!' : 'A meglévő csoportokhoz hozzáadódnak.'))) {
              if (replaceMode) { groups = newGroups; } else { groups = groups.concat(newGroups); }
              activeGroup = 0; page = 0;
              save(); applySettings(); renderGroups(); renderDials();
              toast('Importálva: ' + newGroups.length + ' csoport, ' + totalDials + ' könyvjelző');
              closeModal();
            }
          } catch(err) { toast('Hiba az importáláskor!'); console.error(err); }
        };
        reader.readAsText(file);
      };
    }
    // Browser Bookmarks Export
    var bmExpBtn = document.getElementById('exportBookmarksBtn');
    if (bmExpBtn) {
      bmExpBtn.onclick = function() {
        var lines = [];
        lines.push('<!DOCTYPE NETSCAPE-Bookmark-file-1>');
        lines.push('<!-- Speed Dial Groups - Bookmarks Export -->');
        lines.push('<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">');
        lines.push('<TITLE>Bookmarks</TITLE>');
        lines.push('<H1>Speed Dial Groups</H1>');
        lines.push('<DL><p>');
        groups.forEach(function(g) {
          var ts = Math.floor(Date.now() / 1000);
          lines.push('    <DT><H3 ADD_DATE="' + ts + '">' + esc(g.n) + '</H3>');
          lines.push('    <DL><p>');
          g.d.forEach(function(d) {
            lines.push('        <DT><A HREF="' + esc(d.u) + '" ADD_DATE="' + ts + '">' + esc(d.t || getDom(d.u)) + '</A>');
          });
          lines.push('    </DL><p>');
        });
        lines.push('</DL><p>');
        var blob = new Blob([lines.join('\n')], {type: 'text/html'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'speed-dial-bookmarks-' + new Date().toISOString().slice(0,10) + '.html';
        a.click();
        URL.revokeObjectURL(a.href);
        toast('Könyvjelzők exportálva');
      };
    }
    // Reset
    var rstBtn = document.getElementById('resetBtn');
    if (rstBtn) {
      rstBtn.onclick = function() {
        if (confirm('FIGYELEM: Ez törli az összes adatodat! Biztosan folytatod?')) {
          defaults();
          save(); applySettings(); renderGroups(); renderDials();
          toast('Adatok törölve');
          closeModal();
        }
      };
    }
    // Group color
    document.querySelectorAll('[data-gc]').forEach(function(inp) {
      inp.oninput = function() { groups[parseInt(inp.dataset.gc)].c = inp.value; save(); renderGroups(); };
    });
    // Group category (individual dropdown)
    document.querySelectorAll('[data-gcat]').forEach(function(sel) {
      sel.onchange = function() { groups[parseInt(sel.dataset.gcat)].cat = sel.value || ''; save(); renderGroups(); openSettings(); };
    });
    // Drag groups to category badges
    document.querySelectorAll('.grp-drag').forEach(function(row) {
      row.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', 'grpcat:' + row.dataset.grpi);
        row.style.opacity = '0.3';
      });
      row.addEventListener('dragend', function() { row.style.opacity = '1'; });
    });
    document.querySelectorAll('.cat-drop').forEach(function(badge) {
      badge.addEventListener('dragover', function(e) {
        e.preventDefault();
        badge.style.borderColor = '#7c83ff';
        badge.style.background = 'rgba(124,131,255,.25)';
        badge.style.transform = 'scale(1.05)';
      });
      badge.addEventListener('dragleave', function() {
        badge.style.borderColor = '';
        badge.style.background = '';
        badge.style.transform = '';
      });
      badge.addEventListener('drop', function(e) {
        e.preventDefault();
        badge.style.borderColor = '';
        badge.style.background = '';
        badge.style.transform = '';
        var data = e.dataTransfer.getData('text/plain');
        if (data.indexOf('grpcat:') === 0) {
          var idx = parseInt(data.slice(7));
          var newCat = badge.dataset.catdrop;
          // Also move any checked groups
          var checked = document.querySelectorAll('.bulk-cb:checked');
          var indices = [idx];
          checked.forEach(function(cb) {
            var bi = parseInt(cb.dataset.bi);
            if (indices.indexOf(bi) === -1) indices.push(bi);
          });
          indices.forEach(function(gi) { groups[gi].cat = newCat; });
          save(); renderGroups();
          toast(indices.length + ' csoport → ' + (newCat || 'nincs kategória'));
          openSettings();
        }
      });
    });
    // Set as home
    document.querySelectorAll('[data-ghome]').forEach(function(btn) {
      btn.onclick = function() { settings.homeGroup = parseInt(btn.dataset.ghome); save(); toast('Kezdőlap beállítva'); openSettings(); };
    });
    // Add new category
    var addCatBtn = document.getElementById('addCatBtn');
    if (addCatBtn) {
      addCatBtn.onclick = function() {
        var inp = document.getElementById('newCatInput');
        var v = inp ? inp.value.trim() : '';
        if (!v) { toast('Adj meg nevet!'); return; }
        // Check if exists
        var existing = getCategories();
        if (existing.indexOf(v) >= 0) { toast('Ez a kategória már létezik!'); return; }
        // Apply to selected groups, or just add to first uncategorized
        var checked = document.querySelectorAll('.bulk-cb:checked');
        if (checked.length > 0) {
          checked.forEach(function(cb) { groups[parseInt(cb.dataset.bi)].cat = v; });
          save(); toast(checked.length + ' csoport → ' + v);
        } else {
          toast('Kategória "' + v + '" létrehozva — jelölj ki csoportokat!');
        }
        renderGroups(); openSettings();
      };
    }
    // Bulk apply
    var bulkApplyBtn = document.getElementById('bulkApplyBtn');
    if (bulkApplyBtn) {
      bulkApplyBtn.onclick = function() {
        var sel = document.getElementById('bulkCatSel');
        var cat = sel ? sel.value : '';
        if (!cat) { toast('Válassz kategóriát!'); return; }
        var checked = document.querySelectorAll('.bulk-cb:checked');
        if (checked.length === 0) { toast('Jelölj ki csoportokat!'); return; }
        checked.forEach(function(cb) { groups[parseInt(cb.dataset.bi)].cat = cat; });
        save(); renderGroups();
        toast(checked.length + ' csoport → ' + cat);
        openSettings();
      };
    }
    // Bulk clear category
    var bulkClearBtn = document.getElementById('bulkClearBtn');
    if (bulkClearBtn) {
      bulkClearBtn.onclick = function() {
        var checked = document.querySelectorAll('.bulk-cb:checked');
        if (checked.length === 0) { toast('Jelölj ki csoportokat!'); return; }
        checked.forEach(function(cb) { groups[parseInt(cb.dataset.bi)].cat = ''; });
        save(); renderGroups();
        toast(checked.length + ' csoport kategóriája eltávolítva');
        openSettings();
      };
    }
    // Select all / none / uncategorized
    var bulkSelAll = document.getElementById('bulkSelAll');
    if (bulkSelAll) {
      bulkSelAll.onclick = function() { document.querySelectorAll('.bulk-cb').forEach(function(cb) { cb.checked = true; }); };
    }
    var bulkSelNone = document.getElementById('bulkSelNone');
    if (bulkSelNone) {
      bulkSelNone.onclick = function() { document.querySelectorAll('.bulk-cb').forEach(function(cb) { cb.checked = false; }); };
    }
    var bulkSelUncat = document.getElementById('bulkSelUncat');
    if (bulkSelUncat) {
      bulkSelUncat.onclick = function() {
        document.querySelectorAll('.bulk-cb').forEach(function(cb) {
          var idx = parseInt(cb.dataset.bi);
          cb.checked = !groups[idx].cat;
        });
      };
    }
    // Group rename
    document.querySelectorAll('[data-gren]').forEach(function(btn) {
      btn.onclick = function() { var i = parseInt(btn.dataset.gren); var n = prompt('Név:', groups[i].n); if (n && n.trim()) { groups[i].n = n.trim(); save(); renderGroups(); openSettings(); } };
    });
    // Group delete
    document.querySelectorAll('[data-gdel]').forEach(function(btn) {
      btn.onclick = function() { var i = parseInt(btn.dataset.gdel); if (confirm('Törlöd: ' + groups[i].n + '?')) { groups.splice(i, 1); if (activeGroup >= groups.length) activeGroup = groups.length - 1; save(); renderGroups(); renderDials(); openSettings(); } };
    });
    // Save
    document.getElementById('setSave').onclick = function() {
      var v = function(id) { return document.getElementById(id); };
      if (v('xClk')) settings.clk = v('xClk').checked;
      if (v('xTabs')) settings.tabs = v('xTabs').checked;
      if (v('xNt')) settings.nt = v('xNt').checked;
      if (v('sr_tabRows')) settings.tabRows = parseInt(v('sr_tabRows').value) || 3;
      // Save per-group dial settings
      var cg = curGroup();
      if (v('sr_cols')) cg.cols = parseInt(v('sr_cols').value) || 5;
      if (v('sr_rows')) cg.rows = parseInt(v('sr_rows').value) || 3;
      if (v('sr_dw')) cg.dw = parseInt(v('sr_dw').value) || 220;
      if (v('sr_dh')) cg.dh = parseInt(v('sr_dh').value) || 170;
      var en = document.querySelector('input[name=xEng]:checked');
      if (en) settings.eng = en.value;
      // Save look settings
      if (!settings.look) settings.look = {};
      var lkFont = document.getElementById('lkFont');
      if (lkFont) settings.look.font = lkFont.value;
      var lkFw = document.getElementById('lkFw');
      if (lkFw) settings.look.fw = lkFw.value;
      ['fsTab','fsDial','fsCat','fsLogo'].forEach(function(k) {
        var el = document.getElementById('sr_' + k);
        if (el) settings.look[k] = parseInt(el.value);
      });
      // Font colors
      ['fcTab','fcDial','fcCat','fcLogo'].forEach(function(k) {
        var el = document.getElementById('lk_' + k);
        if (el) settings.look[k] = el.value;
      });
      // Dial radius
      var dr = document.getElementById('sr_dialRadius');
      if (dr) settings.look.dialRadius = parseInt(dr.value);
      page = 0; save(); applySettings(); renderGroups(); renderDials(); toast('Mentve'); closeModal();
    };
  }, 50);
}

function applySettings() {
  document.getElementById('clockWidget').style.display = settings.clk ? '' : 'none';
  document.getElementById('tabsBar').style.display = settings.tabs ? 'flex' : 'none';
  // Tab rows limit
  var tabRows = settings.tabRows || 3;
  var groupTabs = document.getElementById('groupTabs');
  if (groupTabs) {
    var lineH = 36; // approx tab height + gap
    groupTabs.style.maxHeight = (tabRows * lineH) + 'px';
    groupTabs.style.overflowY = tabRows < 10 ? 'auto' : 'visible';
  }
  // Apply look
  var lk = settings.look || {};
  document.body.style.fontFamily = lk.font || 'system-ui, sans-serif';
  // Load Google Font if needed
  var gf = lk.font || '';
  var fontName = gf.split(',')[0].trim();
  if (fontName && fontName !== 'system-ui' && fontName !== 'monospace') {
    var linkId = 'gfont-' + fontName.replace(/\s/g, '');
    if (!document.getElementById(linkId)) {
      var link = document.createElement('link');
      link.id = linkId;
      link.rel = 'stylesheet';
      link.href = 'https://fonts.googleapis.com/css2?family=' + encodeURIComponent(fontName) + ':wght@400;500;600;700&display=swap';
      document.head.appendChild(link);
    }
  }
  // Apply font sizes via CSS custom properties
  document.documentElement.style.setProperty('--fs-tab', (lk.fsTab || 13) + 'px');
  document.documentElement.style.setProperty('--fs-dial', (lk.fsDial || 11) + 'px');
  document.documentElement.style.setProperty('--fs-cat', (lk.fsCat || 11) + 'px');
  document.documentElement.style.setProperty('--fs-logo', (lk.fsLogo || 15) + 'px');
  document.documentElement.style.setProperty('--fw-dial', lk.fw || '600');
  // Apply font colors
  document.documentElement.style.setProperty('--fc-tab', lk.fcTab || '#9090b0');
  document.documentElement.style.setProperty('--fc-dial', lk.fcDial || '#ffffff');
  document.documentElement.style.setProperty('--fc-cat', lk.fcCat || '#606080');
  document.documentElement.style.setProperty('--fc-logo', lk.fcLogo || '#7c83ff');
  document.documentElement.style.setProperty('--dial-radius', (typeof lk.dialRadius==='number'?lk.dialRadius:12) + 'px');
  // Apply theme
  if (settings.theme === 'light') {
    document.documentElement.setAttribute('data-t', 'l');
    document.getElementById('themebtn').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>Téma';
  } else {
    document.documentElement.setAttribute('data-t', '');
    document.getElementById('themebtn').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>Téma';
  }
}

// === BUTTON HANDLERS ===
document.getElementById('btnTop').addEventListener('click', function(e) { e.stopPropagation(); openTopSites(); });
document.getElementById('btnTimer').addEventListener('click', function(e) { e.stopPropagation(); openTimer(); });
document.getElementById('btnNotes').addEventListener('click', function(e) { e.stopPropagation(); openNotes(); });
document.getElementById('btnSettings').addEventListener('click', function(e) { e.stopPropagation(); openSettings(); });
document.getElementById('addGroupBtn').addEventListener('click', function() {
  var n = prompt('Új csoport neve:');
  if (n && n.trim()) { groups.push({n: n.trim(), c: COLORS[groups.length % COLORS.length], cols:5, rows:3, dw:220, dh:170, d: []}); activeGroup = groups.length - 1; page = 0; save(); renderGroups(); renderDials(); toast('Létrehozva'); }
});
document.getElementById('themebtn').addEventListener('click', function() {
  var isL = document.documentElement.getAttribute('data-t') === 'l';
  settings.theme = isL ? 'dark' : 'light';
  save();
  applySettings();
});

// === CLOCK ===
function updateClock() {
  var n = new Date();
  document.getElementById('clockTime').textContent = [n.getHours(), n.getMinutes(), n.getSeconds()].map(function(v) { return String(v).padStart(2, '0'); }).join(':');
  var days = ['Vas','Hét','Kedd','Sze','Csüt','Pén','Szo'];
  var mos = ['jan','feb','már','ápr','máj','jún','júl','aug','sze','okt','nov','dec'];
  document.getElementById('clockDate').textContent = n.getFullYear() + '. ' + mos[n.getMonth()] + '. ' + n.getDate() + '. ' + days[n.getDay()];
}


// === CONTEXT MENU ===
var _ctxDialIdx = -1;
function showCtxMenu(x, y, items) {
  var menu = document.getElementById('ctxMenu');
  menu.innerHTML = '';
  items.forEach(function(item) {
    if (item === '---') {
      var sep = document.createElement('div');
      sep.className = 'ctx-sep';
      menu.appendChild(sep);
    } else {
      var el = document.createElement('div');
      el.className = 'ctx-item';
      el.innerHTML = item.label;
      el.onclick = function() { hideCtxMenu(); item.action(); };
      menu.appendChild(el);
    }
  });
  // Position
  menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(y, window.innerHeight - menu.scrollHeight - 10) + 'px';
  menu.classList.add('v');
}
function hideCtxMenu() { document.getElementById('ctxMenu').classList.remove('v'); }
document.addEventListener('click', hideCtxMenu);
document.addEventListener('contextmenu', function(e) {
  // Check if right-clicked on a group tab
  var tabEl = e.target.closest('.tab');
  if (tabEl && tabEl.closest('#groupTabs')) {
    e.preventDefault();
    var gi = parseInt(tabEl.dataset.gi);
    if (isNaN(gi) || !groups[gi]) return;
    var grp = groups[gi];
    var items = [
      {label: '&#10133; Új csoport létrehozása', action: function() {
        var name = prompt('Új csoport neve:');
        if (name && name.trim()) {
          groups.push({n: name.trim(), c: COLORS[groups.length % COLORS.length], cols: 5, rows: 3, dw: 220, dh: 170, d: [], cat: grp.cat || ''});
          save(); renderGroups(); toast('Csoport létrehozva: ' + name.trim());
        }
      }},
      {label: '&#9998; Átnevezés', action: function() {
        var name = prompt('Új név:', grp.n);
        if (name && name.trim()) { grp.n = name.trim(); save(); renderGroups(); toast('Átnevezve'); }
      }},
      {label: '&#128465; Csoport törlése', action: function() {
        if (confirm('Törlöd a "' + grp.n + '" csoportot és az összes benne lévő tárcsát?')) {
          groups.splice(gi, 1);
          if (activeGroup >= groups.length) activeGroup = Math.max(0, groups.length - 1);
          save(); renderGroups(); renderDials();
          toast('Csoport törölve');
        }
      }},
      '---',
      {label: '&#128196; Minden tárcsa megnyitása (' + grp.d.length + ')', action: function() {
        if (grp.d.length > 10 && !confirm(grp.d.length + ' oldalt nyitunk meg. Folytatod?')) return;
        grp.d.forEach(function(d, di) { setTimeout(function() { window.open(d.u, '_blank'); }, di * 100); });
        toast(grp.d.length + ' oldal megnyitása...');
      }},
      {label: '&#128247; Minden kép frissítése (' + grp.d.length + ')', action: function() {
        grp.d.forEach(function(d) { d.img = ''; delete fails[d.i]; });
        save(); renderDials();
        toast(grp.d.length + ' kép frissítés...');
      }}
    ];
    showCtxMenu(e.clientX, e.clientY, items);
    return;
  }
  // Check if right-clicked on a dial
  var dialEl = e.target.closest('.dial:not(.add)');
  if (dialEl) {
    e.preventDefault();
    var idx = parseInt(dialEl.dataset.idx);
    var g = curGroup();
    if (!g || isNaN(idx) || !g.d[idx]) return;
    var d = g.d[idx];
    var items = [
      {label: '&#128279; Oldal megnyitása', action: function() { window.open(d.u, '_blank'); }},
      {label: '&#128448; Megnyitás itt', action: function() { window.open(d.u, '_self'); }},
      '---',
      {label: '&#128196; Minden oldal megnyitása új lapon (' + g.d.length + ')', action: function() {
        if (g.d.length > 10 && !confirm(g.d.length + ' oldalt nyitunk meg. Folytatod?')) return;
        g.d.forEach(function(dial, di) { setTimeout(function() { window.open(dial.u, '_blank'); }, di * 100); });
        toast(g.d.length + ' oldal megnyitása...');
      }},
      {label: '&#128247; Kép frissítése', action: function() {
        d.img = '';
        delete fails[d.i];
        save(); renderDials();
        toast('Kép frissítés...');
      }},
      {label: '&#128247; Összes kép frissítése', action: function() {
        g.d.forEach(function(dial) {
          dial.img = '';
          delete fails[dial.i];
        });
        save(); renderDials();
        toast(g.d.length + ' kép frissítés...');
      }},
      '---',
      {label: '&#9998; Szerkesztés', action: function() { openDialModal(d); }},
      {label: '&#128465; Törlés', action: function() {
        if (confirm('Törlöd: ' + d.t + '?')) {
          g.d.splice(idx, 1);
          save(); renderDials(); renderGroups();
          toast('Törölve');
        }
      }}
    ];
    showCtxMenu(e.clientX, e.clientY, items);
    return;
  }
  // Right-click on grid background
  var gridEl = e.target.closest('#grid');
  if (gridEl && !dialEl) {
    e.preventDefault();
    var items = [
      {label: '&#10133; Új tárcsa hozzáadása', action: function() { openDialModal(); }},
      '---',
      {label: '&#128196; Minden oldal megnyitása', action: function() {
        var g = curGroup();
        if (g) {
          if (g.d.length > 10 && !confirm(g.d.length + ' oldalt nyitunk meg. Folytatod?')) return;
          g.d.forEach(function(d, di) { setTimeout(function() { window.open(d.u, '_blank'); }, di * 100); });
          toast(g.d.length + ' oldal megnyitása...');
        }
      }},
      {label: '&#128247; Összes kép frissítése', action: function() {
        var g = curGroup();
        if (g) { g.d.forEach(function(d) { d.img = ''; delete fails[d.i]; }); save(); renderDials(); toast('Képek frissítése...'); }
      }}
    ];
    showCtxMenu(e.clientX, e.clientY, items);
    return;
  }
  // Right-click on category bar
  var catEl = e.target.closest('.cat-btn');
  if (catEl) {
    e.preventDefault();
    // Determine which category
    var catText = catEl.textContent.split(' (')[0].trim();
    var isAll = catText === 'Összes';
    var isNone = catText === 'Nincs';
    var catName = isAll ? '__all__' : (isNone ? '' : catText);

    var items = [];
    items.push({label: '&#10133; Új kategória létrehozása', action: function() {
      var name = prompt('Új kategória neve:');
      if (name && name.trim()) {
        var existing = getCategories();
        if (existing.indexOf(name.trim()) >= 0) { toast('Már létezik!'); return; }
        // Assign to first uncategorized group
        var ug = groups.find(function(g) { return !g.cat; });
        if (ug) { ug.cat = name.trim(); save(); renderGroups(); toast('Kategória: ' + name.trim()); }
        else { toast('Nincs kategorizálatlan csoport!'); }
      }
    }});
    if (!isAll && !isNone) {
      items.push({label: '&#9998; Kategória átnevezése', action: function() {
        var newName = prompt('Új név:', catName);
        if (newName && newName.trim() && newName.trim() !== catName) {
          groups.forEach(function(g) { if (g.cat === catName) g.cat = newName.trim(); });
          if (activeCat === catName) activeCat = newName.trim();
          save(); renderGroups(); renderDials();
          toast(catName + ' → ' + newName.trim());
        }
      }});
      items.push({label: '&#128465; Kategória törlése', action: function() {
        if (confirm('Törlöd a "' + catName + '" kategóriát? A csoportok megmaradnak, csak a kategória szűnik meg.')) {
          groups.forEach(function(g) { if (g.cat === catName) g.cat = ''; });
          if (activeCat === catName) activeCat = '__all__';
          save(); renderGroups(); renderDials();
          toast('Kategória törölve: ' + catName);
        }
      }});
    }
    showCtxMenu(e.clientX, e.clientY, items);
    return;
  }
});

// === KEYBOARD ===
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

// === RESIZE ===
var _resizeTimer;
window.addEventListener('resize', function() {
  clearTimeout(_resizeTimer);
  _resizeTimer = setTimeout(function() { renderDials(); }, 150);
});

// === INIT ===
load();
applySettings();
renderGroups();
renderDials();
updateClock();
setInterval(updateClock, 1000);

// Wait for Google API to load, then init auth
function waitForGapi() {
  if (typeof gapi !== 'undefined' && gapi.load) {
    gapiLoaded();
  } else {
    setTimeout(waitForGapi, 200);
  }
}
waitForGapi();

// === URL PARAMETER: ?add=URL&title=TITLE ===
var _addHandled = false;
function checkAddParam() {
  if (_addHandled) return;
  var params = new URLSearchParams(window.location.search);
  var addUrl = params.get('add');
  if (addUrl && driveLoaded) {
    _addHandled = true;
    var addTitle = params.get('title') || '';
    // Small delay to ensure DOM is fully settled
    setTimeout(function() {
      openDialModal(null, addUrl, addTitle);
    }, 300);
    window.history.replaceState({}, '', window.location.pathname);
  }
}
</script>
</body>
</html>
